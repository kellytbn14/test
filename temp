options.Events.OnRedirectToIdentityProvider = context =>
{
    var nonce = Guid.NewGuid().ToString(); 
    context.Properties.Items["nonce"] = nonce;
    context.ProtocolMessage.SetParameter("nonce", nonce);
    return Task.CompletedTask;
};


RedirectToIdentityProvider = context =>
{
    string nonce = Guid.NewGuid().ToString("N");

    context.OwinContext.Response.Cookies.Append(
        "OpenIdConnect.nonce." + nonce,
        nonce,
        new CookieOptions
        {
            HttpOnly = true,
            Secure = true,
            SameSite = SameSiteMode.None
        });

    context.ProtocolMessage.Nonce = nonce;
    return Task.CompletedTask;
};


CookieSameSite = Microsoft.Owin.SameSiteMode.None,
CookieSecure = CookieSecureOption.Always,
CookieSameSite = Microsoft.Owin.SameSiteMode.Lax, // O usar "Strict"


MessageReceived = context =>
{
    var cookies = context.OwinContext.Request.Cookies;
    foreach (var cookie in cookies)
    {
        Console.WriteLine($"[MessageReceived] Cookie: {cookie.Key} = {cookie.Value}");
    }
    return Task.CompletedTask;
},


if (context.Exception.Message.Contains("IDX21323"))
    {
        context.Response.Redirect("/error?message=nonce_error");
    }
    else
    {
        context.Response.Redirect("/error?message=" + Uri.EscapeDataString(context.Exception.Message));
    }

            context.Response.Redirect("/error?message=" + Uri.EscapeDataString(context.Exception.Message));



if (!tokenResponse.IsSuccessStatusCode)
        {
            // Loguear el error si falla la solicitud del token
            var errorContent = await tokenResponse.Content.ReadAsStringAsync();
            LogHelper.Log($"[Auth] Error al obtener el token: {errorContent}", level: LogHelper.LogLevel.Error);
            return;
        }


app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
{
    ClientId = ConfigurationManager.AppSettings["ClientId"],
    Authority = ConfigurationManager.AppSettings["Authority"],
    RedirectUri = ConfigurationManager.AppSettings["RedirectUri"],
    ResponseType = OpenIdConnectResponseType.IdToken,
    UseTokenLifetime = false,
    
    TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true,
        ValidateAudience = true,
        ValidateLifetime = true
    },

    ProtocolValidator = new OpenIdConnectProtocolValidator
    {
        RequireNonce = true // ‚úÖ Aqu√≠ s√≠ es v√°lido
    }
});


app.UseCookieAuthentication(new CookieAuthenticationOptions
{
    AuthenticationType = CookieAuthenticationDefaults.AuthenticationType,
    SlidingExpiration = true, // üîÑ Renueva el tiempo de expiraci√≥n con cada solicitud
    ExpireTimeSpan = TimeSpan.FromMinutes(60), // ‚è≥ Expira en 60 minutos
    CookieSecure = CookieSecureOption.Always, // üîê Solo permite cookies en HTTPS
    CookieHttpOnly = true, // üõë Previene acceso a la cookie desde JavaScript
    CookieSameSite = SameSiteMode.None, // ‚ö†Ô∏è Permite compartir cookies entre sitios (si necesario)
    CookiePath = "/", // üìç Asegura que se almacene correctamente la cookie
    LoginPath = new PathString("/Auth/Login.aspx"), // üîÑ Ruta de login si la sesi√≥n expira
    LogoutPath = new PathString("/Auth/Logout.aspx") // üö™ Ruta de logout
});

AuthenticationFailed = context =>
{
    LogHelper.Log($"[Auth] Authentication Failed: {context.Exception.Message}", level: LogHelper.LogLevel.Error);
    LogHelper.Log($"[Auth] Full Exception: {context.Exception}", level: LogHelper.LogLevel.Debug);
    
    // Registrar m√°s detalles sobre el contexto
    if (context.ProtocolMessage != null)
    {
        LogHelper.Log($"[Auth] Protocol Message: {context.ProtocolMessage}", level: LogHelper.LogLevel.Debug);
    }

    return Task.CompletedTask;
},

app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
{
    AuthenticationMode = AuthenticationMode.Passive,
    ClientId = ConfigurationManager.AppSettings["ClientId"],
    Authority = ConfigurationManager.AppSettings["Authority"],
    RedirectUri = ConfigurationManager.AppSettings["RedirectUri"],
    ResponseType = OpenIdConnectResponseType.IdToken,
    UseTokenLifetime = false, // ‚è≥ Evita que la autenticaci√≥n dependa solo del token
    TokenValidationParameters = new TokenValidationParameters
    {
        RequireNonce = true, // ‚úÖ Asegura que el nonce se usa correctamente
        ValidateIssuer = true,
        ValidateAudience = true,
        ValidateLifetime = true
    }
});


LogHelper.Log($"[Auth] Authentication Failed!", level: LogHelper.LogLevel.Error);
    LogHelper.Log($"Exception: {context.Exception}", level: LogHelper.LogLevel.Error);
    LogHelper.Log($"ProtocolMessage: {context.ProtocolMessage?.ToString()}", level: LogHelper.LogLevel.Error);
    LogHelper.Log($"Request.Path: {context.Request?.Path}", level: LogHelper.LogLevel.Error);
    LogHelper.Log($"RedirectUri: {context.Options?.RedirectUri}", level: LogHelper.LogLevel.Error);

AuthenticationFailed = context =>
{
    string contextData = JsonConvert.SerializeObject(context, Formatting.Indented);
    LogHelper.Log($"[Auth] Authentication Failed Context: {contextData}", level: LogHelper.LogLevel.Error);

    return Task.CompletedTask;
};



app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
{
    ...
    Notifications = new OpenIdConnectAuthenticationNotifications
    {
        RedirectToIdentityProvider = context =>
        {
            // Forzar nuevo nonce
            context.ProtocolMessage.Nonce = Guid.NewGuid().ToString();
            return Task.CompletedTask;
        }
    }
});


string errorMessage = context.Failure != null ? context.Failure.Message : "No failure message";
    LoggingLogHelper.Log($"[Startup] AuthenticationFailed: {errorMessage}", environment: "", level: LoggingLogHelper.LogLevel.Debug);
 
string user = context.Principal?.Identity?.Name ?? "Usuario no autenticado";
    LoggingLogHelper.Log($"[Startup] AuthenticationFailed - Usuario: {user}", environment: "", level: LoggingLogHelper.LogLevel.Debug);

if (context.Principal != null)
    {
        foreach (var claim in context.Principal.Claims)
        {
            LoggingLogHelper.Log($"[Startup] Claim: {claim.Type} - {claim.Value}", environment: "", level: LoggingLogHelper.LogLevel.Debug);
        }
    }
    else
    {
        LoggingLogHelper.Log("[Startup] No se recibieron claims", environment: "", level: LoggingLogHelper.LogLevel.Debug);
    }

var headers = context.Request.Headers;
    foreach (var header in headers)
    {
        LoggingLogHelper.Log($"[Startup] Header: {header.Key} - {header.Value}", environment: "", level: LoggingLogHelper.LogLevel.Debug);
    }

app.UseCookieAuthentication(new CookieAuthenticationOptions
{
    AuthenticationType = CookieAuthenticationDefaults.AuthenticationType,
    ExpireTimeSpan = TimeSpan.FromMinutes(30),

    Events = new CookieAuthenticationEvents
    {
        OnRedirectToLogin = context =>
        {
            // URL de WAM obtenida de configuraci√≥n
            string wamRedirectUri = ConfigurationManager.AppSettings["WamRedirectUri"];
            
            // Redirigir al usuario a WAM si no est√° autenticado
            context.Response.Redirect(wamRedirectUri);
            return Task.CompletedTask;
        }
    }
});


<system.webServer>
    <modules runAllManagedModulesForAllRequests="true">
        <add name="Owin" type="Microsoft.Owin.Host.SystemWeb.OwinHttpModule, Microsoft.Owin.Host.SystemWeb" />
    </modules>
</system.webServer>


using Microsoft.Owin.Security;
using System.Security.Claims;

var user = HttpContext.Current.GetOwinContext().Authentication.User;
if (user.Identity.IsAuthenticated)
{
    string userName = user.Identity.Name; // Nombre del usuario autenticado
    string email = user.FindFirst(ClaimTypes.Email)?.Value; // Correo electr√≥nico
    string userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value; // ID del usuario
    string role = user.FindFirst(ClaimTypes.Role)?.Value; // Rol del usuario (si est√° disponible)
}


<add key="serilog:using:Debug" value="Serilog.Sinks.Debug"/>
<add key="serilog:write-to:Debug"/>

HttpContext.Current.GetOwinContext().Authentication.SignOut(
        CookieAuthenticationDefaults.AuthenticationType, 
        OpenIdConnectAuthenticationDefaults.AuthenticationType
    );

    Response.Redirect("~/Auth/Login.aspx");


public void Configuration(IAppBuilder app)
{
    // Configurar autenticaci√≥n con cookies
    app.UseCookieAuthentication(new CookieAuthenticationOptions
    {
        AuthenticationType = CookieAuthenticationDefaults.AuthenticationType
    });

    // Configurar autenticaci√≥n con OpenID Connect
    app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
    {
        ClientId = "tu-client-id",
        Authority = "https://wam-ist.cloud.bns:443/sso/oauth2/bns",
        RedirectUri = "https://tu-app/callback",
        ResponseType = OpenIdConnectResponseType.CodeIdToken,
        SignInAsAuthenticationType = CookieAuthenticationDefaults.AuthenticationType
    });
}


app.UseCookieAuthentication(new CookieAuthenticationOptions());



https://wam-ist.cloud.bns/sso/oauth2/bns/.well-known/openid-configuration

2Ô∏è‚É£ Si WAM no tiene metadatos, configura manualmente los endpoints:

app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
{
    ClientId = "tu-cliente-id",
    Authority = "https://wam-ist.cloud.bns/sso/oauth2/bns",
    RedirectUri = "https://tu-aplicacion.com/signin-oidc",
    ResponseType = OpenIdConnectResponseType.CodeIdToken,
    Scope = "openid profile",
    TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = false
    },
    Configuration = new OpenIdConnectConfiguration
    {
        AuthorizationEndpoint = "https://wam-ist.cloud.bns/sso/oauth2/bns/authorize",
        TokenEndpoint = "https://wam-ist.cloud.bns/sso/oauth2/bns/token",
        UserInfoEndpoint = "https://wam-ist.cloud.bns/sso/oauth2/bns/userinfo"
    }
});




app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
{
    ClientId = "tu-cliente-id",
    Authority = "https://wam-ist.cloud.bns/sso/oauth2/bns",
    MetadataAddress = "https://wam-ist.cloud.bns/sso/oauth2/bns/authorize", // Usa la URL correcta
    RedirectUri = "https://tu-aplicacion.com/signin-oidc", // Cambia esto por la URL de tu app
    ResponseType = OpenIdConnectResponseType.CodeIdToken,
    Scope = "openid profile",
    TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = false
    }
});



public class Startup
{
    public void Configuration(IAppBuilder app)
    {
        string clientid = ConfigurationManager.AppSettings["WamClientId"];
        string secret = ConfigurationManager.AppSettings["WamClientSecret"];
        string authority = ConfigurationManager.AppSettings["WamAuthority"];
        string redirectUri = ConfigurationManager.AppSettings["WamRedirectUri"];
        string responseType = ConfigurationManager.AppSettings["WamResponseType"];
        string postlogoutRedirectUri = ConfigurationManager.AppSettings["PostLogoutRedirectUri"];

        int expireTimeSpan = int.TryParse(ConfigurationManager.AppSettings["ExpireTimeSpan"], out int minutes) ? minutes : 30;

        if (string.IsNullOrEmpty(clientid) || string.IsNullOrEmpty(secret) || string.IsNullOrEmpty(authority) || string.IsNullOrEmpty(redirectUri) || string.IsNullOrEmpty(responseType))
        {
            throw new Exception("Missing settings in Web.config");
        }

        ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;
        IdentityModelEventSource.ShowPII = true;

        app.UseCookieAuthentication(new CookieAuthenticationOptions
        {
            AuthenticationType = "Cookies",
            ExpireTimeSpan = TimeSpan.FromMinutes(expireTimeSpan),
            SlidingExpiration = true,
            LoginPath = new PathString("/Auth/Login.aspx"), // ‚úÖ CORREGIDO
        });

        app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
        {
            ClientId = clientid,
            ClientSecret = secret,
            Authority = authority,
            RedirectUri = redirectUri,
            ResponseType = responseType, // Asegurar que sea "code id_token"
            Scope = "openid",
            SignInAsAuthenticationType = "Cookies",
            SaveTokens = true,
            PostLogoutRedirectUri = postlogoutRedirectUri,

            Notifications = new OpenIdConnectAuthenticationNotifications
            {
                SecurityTokenValidated = context =>
                {
                    var identity = (ClaimsIdentity)context.AuthenticationTicket.Identity;
                    var idToken = context.ProtocolMessage.IdToken;

                    if (!string.IsNullOrEmpty(idToken))
                    {
                        identity.AddClaim(new Claim("id.token", idToken));
                    }

                    return Task.CompletedTask;
                },
                AuthorizationCodeReceived = async context =>
                {
                    var code = context.Code;
                    var tokenClient = new HttpClient();
                    var tokenResponse = await tokenClient.PostAsync(ConfigurationManager.AppSettings["TokenEndpoint"],
                        new FormUrlEncodedContent(new Dictionary<string, string>
                        {
                            {"client_id", clientid },
                            {"client_secret", secret },
                            { "code", code },
                            { "redirect_uri", redirectUri },
                            { "grant_type", "authorization_code" }, // ‚úÖ CORREGIDO
                        }));
                    var tokenResult = await tokenResponse.Content.ReadAsStringAsync();

                    // ‚úÖ IMPORTANTE: Guardar la sesi√≥n
                    var authenticationManager = context.OwinContext.Authentication;
                    authenticationManager.SignIn(new AuthenticationProperties(), context.AuthenticationTicket.Identity);
                },
                AuthenticationFailed = context =>
                {
                    context.HandleResponse();
                    context.Response.Redirect("/Auth/Logout.aspx");
                    return Task.CompletedTask;
                }
            },
        });
    }
}



public void ConfigureAuth(IAppBuilder app)
{
    app.UseCookieAuthentication(new CookieAuthenticationOptions
    {
        AuthenticationType = CookieAuthenticationDefaults.AuthenticationType,
        LoginPath = new PathString("/Auth/Logout.aspx"), // Esto NO es el login, sino la p√°gina de error
        ExpireTimeSpan = TimeSpan.FromMinutes(30),
        SlidingExpiration = true
    });

    app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
    {
        Authority = "https://tu-wam-provider.com/",
        ClientId = "tu-client-id",
        RedirectUri = "https://tu-app.com/signin-oidc",
        ResponseType = OpenIdConnectResponseType.CodeIdToken,
        Scope = "openid profile",
        SignInAsAuthenticationType = CookieAuthenticationDefaults.AuthenticationType,
        SaveTokens = true,
        Notifications = new OpenIdConnectAuthenticationNotifications
        {
            AuthenticationFailed = context =>
            {
                context.HandleResponse();
                context.Response.Redirect("/Auth/Logout.aspx"); // Redirige a la p√°gina de error si falla la autenticaci√≥n
                return Task.CompletedTask;
            }
        }
    });
}

protected void Page_Load(object sender, EventArgs e)
{
    if (!User.Identity.IsAuthenticated)
    {
        HttpContext.Current.GetOwinContext().Authentication.Challenge(
            new AuthenticationProperties { RedirectUri = "/" },
            OpenIdConnectAuthenticationDefaults.AuthenticationType
        );
    }
    else
    {
        Response.Redirect("~/Default.aspx");
    }
}


protected void Page_Load(object sender, EventArgs e)
{
    if (Request.IsAuthenticated)
    {
        HttpContext.Current.GetOwinContext().Authentication.SignOut(
            CookieAuthenticationDefaults.AuthenticationType,
            OpenIdConnectAuthenticationDefaults.AuthenticationType
        );
    }

    Response.Redirect("~/Auth/ForceLogin.aspx"); // Vuelve a redirigir al login
}




HttpContext.Current.GetOwinContext().Authentication.Challenge(
                new AuthenticationProperties { RedirectUri = Request.Url.ToString() },
                OpenIdConnectAuthenticationDefaults.AuthenticationType
            );



<%@ Page Language="C#" AutoEventWireup="true" CodeBehind="Logout.aspx.cs" Inherits="TuProyecto.Logout" %>

<!DOCTYPE html>
<html lang="es">
<head runat="server">
    <meta charset="utf-8" />
    <title>No Autenticado</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        .container { max-width: 400px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; }
        h2 { color: red; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h2>¬°Acceso no permitido!</h2>
        <p>No tienes una sesi√≥n activa. Por favor, inicia sesi√≥n para continuar.</p>
        <button onclick="window.location.href='Default.aspx'">Volver a la P√°gina Principal</button>
    </div>
</body>
</html>

using System;
using System.Web;
using System.Web.UI;

namespace TuProyecto
{
    public partial class Logout : Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            // Cerrar sesi√≥n
            Session.Clear();  // Elimina todas las variables de sesi√≥n
            Session.Abandon(); // Finaliza la sesi√≥n actual
            HttpContext.Current.User = null; // Borra la identidad del usuario
            
            // Redirigir al Login despu√©s de 5 segundos
            Response.AppendHeader("Refresh", "5;url=Login.aspx");
        }
    }
}



public class AuthPage : System.Web.UI.Page
{
    protected override void OnInit(EventArgs e)
    {
        base.OnInit(e); // Llamar a la implementaci√≥n base de OnInit

        if (!HttpContext.Current.User.Identity.IsAuthenticated)
        {
            // Mostrar un mensaje en la consola del navegador
            ClientScript.RegisterStartupScript(this.GetType(), "consoleLog", "console.log('[AuthPage] No autenticado! Redirigiendo...');", true);

            // Redirigir al login
            Response.Redirect("~/Login.aspx", true);
            
            // IMPORTANTE: Detener la ejecuci√≥n de la p√°gina
            Context.ApplicationInstance.CompleteRequest();
        }
    }

    protected override void OnLoad(EventArgs e)
    {
        base.OnLoad(e); // Llamar a la implementaci√≥n base de OnLoad

        // Si el usuario ya est√° autenticado, obtener el token
        var identity = (ClaimsIdentity)HttpContext.Current.User.Identity;
        var idTokenClaim = identity.FindFirst("id.token");

        if (idTokenClaim != null)
        {
            string idToken = idTokenClaim.Value;

            // Mostrar el ID Token en la consola del navegador
            ClientScript.RegisterStartupScript(this.GetType(), "consoleLogId", $"console.log('ID Token: {idToken}');", true);
        }
    }
}



if (this is System.Web.UI.Page)
{
    Response.Write("ESOP_Landing efectivamente hereda de Page");
}



EnableViewState="true"

 AutoEventWireup="true"


SecurityTokenValidated = context =>
{
    var identity = (ClaimsIdentity)context.AuthenticationTicket.Identity;

    // Obtener el id_token desde el contexto
    var idToken = context.ProtocolMessage.IdToken;

    if (!string.IsNullOrEmpty(idToken))
    {
        // Agregar el id_token como un claim
        identity.AddClaim(new Claim("id_token", idToken));
    }

    return Task.CompletedTask;
}



ClientScript.RegisterStartupScript(this.GetType(), "consoleLog",
                $"console.log('ID Token: {idToken}');", true);


ClientScript.RegisterStartupScript(this.GetType(), "consoleLog", "console.log('Mensaje desde el servidor');", true);


var identity = (ClaimsIdentity)HttpContext.Current.User.Identity;
var idTokenClaim = identity.FindFirst("id_token");

if (idTokenClaim != null)
{
    string idToken = idTokenClaim.Value;
    Console.WriteLine("ID Token: " + idToken);
}




app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
{
    ClientId = ConfigurationManager.AppSettings["ClientId"],
    Authority = ConfigurationManager.AppSettings["Authority"],
    RedirectUri = ConfigurationManager.AppSettings["RedirectUri"],
    ResponseType = "code",  // Se usa "code" en lugar de "id_token"
    Scope = "openid profile",
    SignInAsAuthenticationType = "Cookies",
    UseTokenLifetime = false,
    Notifications = new OpenIdConnectAuthenticationNotifications
    {
        AuthorizationCodeReceived = async context =>
        {
            var code = context.Code;

            // Intercambiar el c√≥digo por tokens (Acceso y Refresh Token)
            var tokenClient = new HttpClient();
            var tokenResponse = await tokenClient.PostAsync(ConfigurationManager.AppSettings["TokenEndpoint"], 
                new FormUrlEncodedContent(new Dictionary<string, string>
                {
                    { "client_id", ConfigurationManager.AppSettings["ClientId"] },
                    { "client_secret", ConfigurationManager.AppSettings["ClientSecret"] },
                    { "code", code },
                    { "redirect_uri", ConfigurationManager.AppSettings["RedirectUri"] },
                    { "grant_type", "authorization_code" }
                }));

            var tokenResult = await tokenResponse.Content.ReadAsStringAsync();
            // Procesar tokens aqu√≠ (acceso, refresh, etc.)
        }
    }
});



using System;
using System.Web;

namespace OIDC.WebForm
{
    public class BasePage : System.Web.UI.Page
    {
        protected override void OnLoad(EventArgs e)
        {
            base.OnLoad(e);

            if (!Request.IsAuthenticated) // Verifica si el usuario est√° autenticado
            {
                Response.Redirect("~/Login.aspx"); // Redirige al login si no est√° autenticado
            }
        }
    }
}




int expirationMinutes = int.TryParse(ConfigurationManager.AppSettings["AuthCookieExpirationMinutes"], out int minutes) ? minutes : 30;

using System;
using System.Configuration;
using Microsoft.Owin;
using Microsoft.Owin.Security.Cookies;
using Microsoft.Owin.Security.OpenIdConnect;
using Owin;

public class Startup
{
    public void Configuration(IAppBuilder app)
    {
        string clientId = ConfigurationManager.AppSettings["WamClientId"];
        string tenantId = ConfigurationManager.AppSettings["WamTenantId"];
        string authority = ConfigurationManager.AppSettings["WamAuthority"];
        string redirectUri = ConfigurationManager.AppSettings["WamRedirectUri"];

        if (string.IsNullOrEmpty(clientId) || string.IsNullOrEmpty(tenantId) || 
            string.IsNullOrEmpty(authority) || string.IsNullOrEmpty(redirectUri))
        {
            throw new Exception("Faltan configuraciones en web.config");
        }

        app.UseCookieAuthentication(new CookieAuthenticationOptions
        {
            AuthenticationType = "Cookies"
        });

        app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
        {
            ClientId = clientId,
            Authority = authority,
            RedirectUri = redirectUri,
            ResponseType = "code id_token",
            Scope = "openid profile email",
            SignInAsAuthenticationType = "Cookies",
            UseTokenLifetime = false,
            SaveTokens = true
        });
    }
}
        int expirationMinutes = int.TryParse(ConfigurationManager.AppSettings["AuthCookieExpirationMinutes"], out int minutes) ? minutes : 30;


<configuration>
  <appSettings>
    <add key="WamClientId" value="tu-client-id" />
    <add key="WamTenantId" value="tu-tenant-id" />
    <add key="WamAuthority" value="https://login.microsoftonline.com/{tu-tenant-id}/v2.0" />
    <add key="WamRedirectUri" value="https://localhost:44333/signin-oidc" />
  </appSettings>
</configuration>


using System;
using System.Configuration;
using Microsoft.Owin;
using Microsoft.Owin.Security.Cookies;
using Microsoft.Owin.Security.OpenIdConnect;
using Owin;

public class Startup
{
    public void Configuration(IAppBuilder app)
    {
        string clientId = ConfigurationManager.AppSettings["WamClientId"];
        string tenantId = ConfigurationManager.AppSettings["WamTenantId"];
        string authority = ConfigurationManager.AppSettings["WamAuthority"];
        string redirectUri = ConfigurationManager.AppSettings["WamRedirectUri"];

        if (string.IsNullOrEmpty(clientId) || string.IsNullOrEmpty(tenantId) || 
            string.IsNullOrEmpty(authority) || string.IsNullOrEmpty(redirectUri))
        {
            throw new Exception("Faltan configuraciones en web.config");
        }

        app.UseCookieAuthentication(new CookieAuthenticationOptions
        {
            AuthenticationType = "Cookies"
        });

        app.UseOpenIdConnectAuthentication(new OpenIdConnectAuthenticationOptions
        {
            ClientId = clientId,
            Authority = authority,
            RedirectUri = redirectUri,
            ResponseType = "code id_token",
            Scope = "openid profile email",
            SignInAsAuthenticationType = "Cookies",
            UseTokenLifetime = false,
            SaveTokens = true
        });
    }
}






<br /><br />

        <!-- Campo de entrada para recibir el c√≥digo -->
        <label for="txtCode">C√≥digo:</label>
        <asp:TextBox ID="txtCode" runat="server"></asp:TextBox>

        <br /><br />


<asp:Button ID="btnLogout" runat="server" Text="Logout" OnClick="LogoutButton_Click" CssClass="btn btn-danger" />



using System;
using System.Web;
using System.Web.UI;

namespace OIDC.NETFramework
{
    public partial class Callback : Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            // 1Ô∏è‚É£ Verificar si hubo error en la autenticaci√≥n
            string error = Request.QueryString["error"];
            if (!string.IsNullOrEmpty(error))
            {
                Response.Write("Error en autenticaci√≥n: " + error);
                return;
            }

            // 2Ô∏è‚É£ Obtener par√°metros de la respuesta OIDC
            string code = Request.QueryString["code"];
            string idToken = Request.QueryString["id_token"];
            string state = Request.QueryString["state"];

            // 3Ô∏è‚É£ Validar el 'state' para prevenir ataques CSRF
            string expectedState = Session["oidc_state"] as string;
            if (string.IsNullOrEmpty(state) || state != expectedState)
            {
                Response.Write("Error: El par√°metro 'state' no coincide. Posible ataque CSRF.");
                return;
            }

            // 4Ô∏è‚É£ Si recibimos 'code', podemos intercambiarlo por tokens (Authorization Code Flow)
            if (!string.IsNullOrEmpty(code))
            {
                Response.Write("C√≥digo de autorizaci√≥n recibido: " + code);
                // Aqu√≠ debes hacer una solicitud HTTP al token endpoint para obtener access_token y id_token
                // (Necesitas un m√©todo para hacer un POST a `token_uri`).
            }

            // 5Ô∏è‚É£ Si ya recibimos el 'id_token', significa que el usuario est√° autenticado
            if (!string.IsNullOrEmpty(idToken))
            {
                Response.Write("ID Token recibido, autenticaci√≥n exitosa.");
                // Aqu√≠ puedes decodificar el id_token y extraer la informaci√≥n del usuario.
            }
        }
    }
}


<EnableAutoLaunch>false</EnableAutoLaunch>
protected void Page_Load(object sender, EventArgs e)
{
    if (User.Identity.IsAuthenticated)
    {
        var claimsIdentity = (ClaimsIdentity)User.Identity;
        var idToken = claimsIdentity.FindFirst("id_token")?.Value;

        if (idToken != null)
        {
            Response.Write("ID Token: " + idToken);
        }
    }
}





using System;
using System.Collections.Specialized;
using System.Net;
using System.Text;
using System.Web;
using Newtonsoft.Json.Linq;

namespace OIDC.NETFramework
{
    public partial class Callback : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            string code = Request.QueryString["code"];
            if (string.IsNullOrEmpty(code))
            {
                Response.Write("Error: No se recibi√≥ el c√≥digo de autorizaci√≥n.");
                return;
            }

            string tokenUrl = "https://wam-ist.cloud.bns/sso/oauth2/bns/access_token";
            using (WebClient client = new WebClient())
            {
                var postData = new NameValueCollection();
                postData["grant_type"] = "authorization_code";
                postData["client_id"] = "HRSSORefresh";
                postData["client_secret"] = "36567bd2-666e-491c-a511-5028eb7a4f13";
                postData["code"] = code;
                postData["redirect_uri"] = "https://localhost:44333/oidc/callback";

                byte[] responseBytes = client.UploadValues(tokenUrl, "POST", postData);
                string responseString = Encoding.UTF8.GetString(responseBytes);
                JObject tokenResponse = JObject.Parse(responseString);

                string idToken = tokenResponse["id_token"]?.ToString();
                string accessToken = tokenResponse["access_token"]?.ToString();

                if (string.IsNullOrEmpty(idToken))
                {
                    Response.Write("Error: No se recibi√≥ un ID Token.");
                    return;
                }

                // Guardar en sesi√≥n para validar autenticaci√≥n
                Session["id_token"] = idToken;
                Session["access_token"] = accessToken;

                Response.Redirect("Default.aspx");
            }
        }
    }
}


curl -X POST "https://wam-ist.cloud.bns/sso/oauth2/bns/access_token" \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "grant_type=authorization_code" \
     -d "client_id=HRSSORefresh" \
     -d "client_secret=36567bd2-666e-491c-a511-5028eb7a4f13" \
     -d "code=TU_AUTH_CODE" \
     -d "redirect_uri=https://localhost:44333/oidc/callback"




using (var client = new HttpClient())
{
    var tokenUrl = "https://wam-ist.cloud.bns/sso/oauth2/bns/access_token";

    var postData = new Dictionary<string, string>
    {
        { "grant_type", "authorization_code" },
        { "client_id", "HRSSORefresh" },
        { "client_secret", "36567bd2-666e-491c-a511-5028eb7a4f13" },
        { "code", code },
        { "redirect_uri", "https://localhost:44333/oidc/callback" }
    };

    var content = new FormUrlEncodedContent(postData);

    HttpResponseMessage response = await client.PostAsync(tokenUrl, content);
    string responseString = await response.Content.ReadAsStringAsync();

    Response.Write(responseString); // Para ver la respuesta del servidor
}



try
                {
                    HttpResponseMessage response = client.PostAsync(tokenUrl, content).Result;
                    string responseString = response.Content.ReadAsStringAsync().Result;

                    Response.Write(responseString); // Verifica si recibes el access_token
                }
                catch (Exception ex)
                {
                    Response.Write("Error en la solicitud del token: " + ex.Message);
                }




protected void SignInUser(string userName, string idToken)
{
    var claims = new List<Claim>
    {
        new Claim(ClaimTypes.Name, userName),
        new Claim("id_token", idToken) // Guardar ID Token si es necesario
    };

    var identity = new ClaimsIdentity(claims, "Cookies");

    var ctx = HttpContext.Current.GetOwinContext();
    var authManager = ctx.Authentication;

    authManager.SignIn(new AuthenticationProperties { IsPersistent = true }, identity);
}



curl -X POST https://tu-idp.com/token \
  -d "grant_type=password" \
  -d "client_id=tu-client-id" \
  -d "client_secret=tu-client-secret" \
  -d "username=usuario@ejemplo.com" \
  -d "password=contrase√±a-del-usuario" \
  -d "scope=openid" \
  -d "redirect_uri=https://localhost:44333/oidc/callback"



public void SignOutUser()
{
    var ctx = HttpContext.Current.GetOwinContext();
    var authManager = ctx.Authentication;

    // Cerrar sesi√≥n y eliminar la cookie
    authManager.SignOut("Cookies");
}


<button id="logoutButton" runat="server" class="btn btn-danger" OnClick="LogoutButton_Click">Logout</button>

